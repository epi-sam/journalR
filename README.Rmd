---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
   collapse = TRUE,
   comment = "#>",
   fig.path = "man/figures/README-",
   out.width = "100%",
   # print 15 lines of table output
   tidy.opts = list(width.cutoff = 120, max.print = 15
   )
)
```

# journalR

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/journalR)](https://CRAN.R-project.org/package=journalR)
[![R-CMD-check](https://github.com/epi-sam/journalR/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/epi-sam/journalR/actions/workflows/R-CMD-check.yaml)
![CRAN downloads](https://cranlogs.r-pkg.org/badges/grand-total/journlaR)
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
<!-- badges: end -->



## Installation


``` r
install.packages("journalR")
```

## Overview

```{r invis_startup,include=FALSE}
library(journalR)
```


**journalR** eases numeric formatting for real-world scientific publication writing. 

The core utility formats triplet sets of central/lower/upper (CLU) raw 
numeric values into a drop-in string that's immediately pasteable into journal 
text.

```{r demo_vec}
journalR::format_journal_clu(2e6, 1e6, 3e6, metric = 'count')
```

This core utility is vectorized, with greatest power coming from data.frame wrappers.

```{r demo_df}
journalR::format_journal_df(
   data.frame(
      id    = 1:3,
      mean  = c(.558, .234, .789),
      lower = c(.507, .201, .756),
      upper = c(.607, .267, .821)
      
   )
   , metric     = "prop"
   , style_name = "lancet"
)
```

The user may also define 'styles' for rounding strategy, significant
digits, numbers of decimals, and more (see 'Styles' below).



## Why journalR?

In the Platonic ideal world, an article is written in Rmarkdown or pure LaTeX.

In the real world, journals are written collaboratively in Word, with multiple messy copies.

Sometimes, you just need to copy and paste some numbers.

```{r example}
library(journalR)
library(data.table) # journalR works on both data.frames and data.tables
```

Once you've done a statistical analysis, you'll want to format numbers for presentation.

```{r mtcars}
DT <- data.table::as.data.table(mtcars)

# calculate mean/lower/upper 95% UI for mpg by cyl
DT_hp <- DT[
   , .(
      mean    = mean(hp)
      , lower = quantile(hp, 0.025)
      , upper = quantile(hp, 0.975)
   )
   , by = cyl
]
data.table::setorderv(DT_hp, 'cyl')

print(DT_hp)
```


Enter `format_journal_df()`:

- Format a central/lower/upper set of three columns into an e.g. "mean (lower--upper)" string.
- Ready for direct copy/paste into Word or similar.
- The user must provide a data type (`metric`), which tells the function how to format the numbers.
- central/lower/upper relationships are asserted (lower < central < upper) before formatting.

```{r format}
DT_hp |>
   journalR::format_journal_df(
      metric = "count"
   )
```



## Options 

The user's data.frame may be formatted differently than the simple case above, with different data types.

- Things get messy in the real world!

```{r options}
# build a mean/lower/upper summary table with some percentage from DT
DT_summary <- DT[
   , .(
      n              = .N
      , mean_mpg     = mean(mpg)
      , lower_mpg    = quantile(mpg, 0.025)
      , upper_mpg    = quantile(mpg, 0.975)
      , pct_vshape   = mean(vs) 
      , lower_vshape = quantile(vs, 0.025) 
      , upper_vshape = quantile(vs, 0.975) 
   )
   , by = cyl
]

```

As long as your table is tidy, it can be formatted.

```{r options_formatted}
DT_summary |>
   journalR::format_journal_df(
      metric               = c("prop")
      , new_var            = "pct_vshape_fmt" # specify output column name
      , central_var        = "pct_vshape" 
      , lower_var          = "lower_vshape"
      , upper_var          = "upper_vshape"
      , remove_clu_columns = FALSE            # retain the original columns if desired
   )
```



## Assumptions


### General:

1. Central/lower/upper triplets are formatted at the same 'scale'.
1. Based on the central value.
1. User may override (see 'Rates' below).
1. All triplets present with the same number of significant digits.




### Proportions:

1. Proportions (prop) and Percentage Points (pp) are multiplied by 100
1. All-negative triplets are presented with negative mean only, with upper and lower bounds reversed.


```{r assumptions_prop}
DT_prop <- data.table::data.table(
   data_space    = c("all_pos", "mixed_neg", "all_neg", "lower_neg", "mean_lower_neg")
   , mean        = c(.558,      -0.1,        -0.1,      0.05,        -0.05)
   , lower       = c(.507,      -0.25,       -0.2,      -0.02,       -0.1)
   , upper       = c(.607,      1.3,         -0.05,     0.12,        0.1)
)
DT_prop|>
   journalR::format_journal_df(
      metric               = "prop"
      , remove_clu_columns = FALSE
   )
```




### Counts:

1. Formatting is applied _after_ scaling.
1. e.g. 55,831,000 first scaled to 55.831000 ...
1. ... then truncated to the correct sigfigs (55.8).
1. Negative counts are not supported.
1. Magnitudes from ones to billions are supported.

```{r assumptions_count}
DF_count <- data.frame(
   data_space = c("thousands", "thousands_edge", "millions", "billions"),
   mean       = c(999000,      999999,           55831000,   5.4717e+12),
   lower      = c(888888,      888888,           50724000,   4.8266e+12),
   upper      = c(2222222,     2222222,          60797000,   5.9786e+12)
)
DF_count|>
   journalR::format_journal_df(
      metric = "count"
   )
```


- Count-space magnitude-edge-cases are handled.
- By default, thousands do not receive a label.
- Users may set their own style with `count_label_thousands = TRUE`.
- See 'Styles' section below for more details.


```{r thou_style_new}
journalR::new_style(
   style_name              = "thousands_labeled"
   , count_label_thousands = TRUE
)
```


```{r thou_style_show}
DF_count|>
   journalR::format_journal_df(
      metric               = "count"
      , style_name         = "thousands_labeled"
   )
```





### Rates:

1. Rates are like counts, but with a `per X <magnitude>` suffix.
1. The user may override the magnitude label easily.



```{r assumptions_rate}
DT_rates <- data.table::data.table(
   id    = 1:3,
   mean  = c(0.000123, 0.0000456, 0.00000789),
   lower = c(0.000100, 0.0000400, 0.00000700),
   upper = c(0.000150, 0.0000500, 0.00000900)
)

# Default magnitude (depends on style settings - see 'Styles' heading below)
journalR::format_journal_df(
   DT_rates
   , metric    = "rate"
   , rate_unit = "deaths"
)

# User Override - one magnitude applies to the entire data.frame
journalR::format_journal_df(
   DT_rates
   , metric    = "rate"
   , rate_unit = "deaths"
   , mag       = "per1m"
)
```


If you're not sure of the available 'mag' options, the error code will tell you.

```{r assumptions_rate_options}
try(
   journalR::format_journal_df(
      DT_rates
      , metric    = "rate"
      , rate_unit = "deaths"
      , mag       = "I_dunno"
   )
)
```


This magnitude override is probably most useful for rates, but is available for ALL metrics.

Proportions:

- In case you've already multiplied by 100

```{r mag_override_prop}
df_prop <- data.frame(
   id    = 1:3,
   mean  = c(55.8, 23.4, 78.9),
   lower = c(50.7, 20.1, 75.6),
   upper = c(60.7, 26.7, 82.1)
)

# The package tries to keep you safe...
try(
   journalR::format_journal_df(
      df_prop
      , metric = "prop"
   )
)

#... and this is how to use what you have
journalR::format_journal_df(
   df_prop
   , metric = "prop"
   , mag    = 'as-is'
)
```


Counts:

```{r mag_override_count}
df_count <- data.frame(
   id    = 1:3,
   mean  = c(55.8e7, 123.4e7, 5.67e10),
   lower = c(50.7e7, 110.2e7, 5.12e10),
   upper = c(60.7e7, 135.6e7, 6.23e10)
)

# Default
journalR::format_journal_df(
   df_count
   , metric = "count"
)

# User Override
journalR::format_journal_df(
   df_count
   , metric = "count"
   , mag    = "b"
)

```




## Styles

Two formatting styles are built into journalR, and the user may extend this.

- Nature (default)
- Lancet (particular)

```{r style_lancet, include=FALSE}
style_lancet <- data.table::as.data.table(stack(style_lancet()))
data.table::setcolorder(style_lancet, "ind")
data.table::setnames(style_lancet, c("ind", "values"), c("key", "value"))
# print(style_lancet()) # as a list
# formatted a little nicer
```

Styles are a key/value list of metadata controlling rounding and formatting.

Here is an example of a very particular style, and how these values affect presentation tables. 

```{r style_lancet_show}
print(style_lancet) 
```

Lancet receives non-standard formatting

- Lancet decimals are `mid_dot()`.
- Thousands counts from 9,999 to 999,999 receive `thin_space()` delimeter.

```{r lancet_format_counts}
journalR::format_journal_df(
   data.frame(
      mean    = c(55.8e3, 54.7e6)
      , lower = c(50.7e3, 48.6e6)
      , upper = c(60.7e3, 59.6e6)
   )
   , metric = "count"
   , style  = "lancet"
)
```


Negatives are handled gracefully.

- Lancet negatives are `en_dash()`.

```{r lancet_format_prop}
journalR::format_journal_df(
   data.table::data.table(
      data_space = c("all_positive", "mixed_negative", "all_negative")
      , mean     = c(.5584654,       -0.15665,         -0.1321684)
      , lower    = c(.5076231,       -0.25321,         -0.235321)
      , upper    = c(.6076589,       1.365432,         -0.056549)
   )
   , metric = "prop"
   , style = "lancet"
)
```

## Extending styles

Users may define their own styles by creating a named list with the same keys as the built-in styles.

- All arguments except the name have sensible defaults - only change what you need.
- Read the `new_style()` documentation carefully to understand how each element affects your final output.
- Using the "sigfig" `count_method` option involves the most assumptions
- Read `fround_count_rate()` source in 'R/format_vectors.R' for implementation details.

```{r new_style}

journalR::new_style(
   style_name            = 'wacky_style'
   , prop_digits_round   = 3
   , prop_nsmall         = 3
   , count_digits_sigfig = 5
   , count_method        = "sigfig"
   , count_pad_sigfigs   = TRUE
   , count_nsmall        = 3
   , neg_mark_mean       = "Negative "
   , neg_mark_UI         = en_dash()
   , UI_text             = "95%UI "
)
```


<!-- Perhaps the user prefers standard thousands separators for counts. -->

```{r apply_wacky_new_style}
# Counts
journalR::format_journal_df(
   data.frame(
      mean            = c(55.8e3, 54.7e6)
      , lower         = c(50.7e3, 48.6e6)
      , upper         = c(60.7e3, 59.6e6)
   )
   , metric = "count"
   , style  = "wacky_style"
)

# Proportions
journalR::format_journal_df(
   data.table::data.table(
      data_space    = c("all_positive", "mixed_negative", "all_negative")
      , mean          = c(.5584654, -0.15665, -0.1321684)
      , lower         = c(.5076231, -0.25321, -0.235321)
      , upper         = c(.6076589, 1.365432, -0.056549)
   )
   , metric = "prop"
   , style  = "wacky_style"
)
```



## Contributing

[Contribution Style Guide](https://github.com/epi-sam/journalR/blob/main/.github/CONTRIBUTING.md)



## Code of Conduct

Please note that the journalR project is released with a [Contributor Code of Conduct](https://contributor-covenant.org/version/2/1/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.


