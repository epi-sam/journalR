---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  # print 15 lines of table output
  tidy.opts = list(width.cutoff = 120, max.print = 15
  )
)
```

# journalR

<!-- badges: start -->
<!-- badges: end -->

The goal of journalR is to ease real-world scientific publication writing. 

## Installation

You can install the development version of journalR from [GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("epi-sam/journalR")
```

## Basics

In the Platonic ideal world, a journal is written in pure LaTeX, Rmarkdown, or
the like.

In the real world, journals are written collaboratively in Word, with messy 
versioning, multiple copies of the same file, broken citations, and enjoy 
constant updates and hand offs between team members.

Sometimes, you just need to copy and paste some numbers.

Enter journalR.

```{r example}
library(journalR)
# data.table is not required, but the author finds it helpful.
library(data.table)
```

Let's say you have done some statistical analysis.

```{r mtcars}
DT <- data.table::as.data.table(mtcars)

# calculate mean/lower/upper 95% UI for mpg by cyl
DT_hp <- DT[
   , .(
        mean  = mean(hp)
      , lower = quantile(hp, 0.025)
      , upper = quantile(hp, 0.975)
   )
   , by = cyl
]
data.table::setorderv(DT_hp, 'cyl')

print(DT_hp)
```

Once they're ready for presentation, you'll want to format them.

Enter `format_journal_df()`:

- Format a central/lower/upper set of three columns into an e.g. `mean (lower -- upper)` string.
   - Ready for easy copy/paste into Word or similar.
- The user must provide a data type (`d_type`), which tells the function how to format the numbers.
   - central/lower/upper relationships are asserted (lower < central < upper) before formatting.

```{r format}
DT_hp |>
   journalR::format_journal_df(
      d_type = "count"
   )
```

## Assumptions


### General:

1. Central/lower/upper triplets are formatted at the same 'scale'.
1. All triplets present with the same number of significant digits.



### Counts:

1. The central value controls the scaling
   1. Formatting is applied _after_ scaling 
      1. e.g. 55,831,000 first scaled to 55.831000 ...
      1. ... then truncated to the correct sigfigs (55.8)
1. Negative counts are not supported
1. Magnitudes over 1 billion are not supported

```{r assumptions_count}
DF_count <- data.frame(
      data_space = c("thousands", "thousands_edge", "millions", "billions"),
      mean       = c(999000,      999999,           55831000,   5.4717e+12),
      lower      = c(888888,      888888,           50724000,   4.8266e+12),
      upper      = c(2222222,     2222222,          60797000,   5.9786e+12)
)
DF_count|>
   journalR::format_journal_df(
      d_type = "count"
   )
```


- Counts are rounded, but not truncated below 1 million
   - e.g. 999,999 presents as 999,000 if rounded to 3 digits
   - Users may set their own style with `label_thousands = TRUE` to override this behavior


```{r thou_style_new}
new_style(
   style_name = "thousands_labeled"
   , label_thousands = TRUE
)
```


```{r thou_style_show}
DF_count|>
   journalR::format_journal_df(
      d_type               = "count"
      , style_name         = "thousands_labeled"
   )
```



### Proportions:

1. Proportions (prop) and Percentage Points (pp) are all multiplied by 100
1. All-negative triplets are presented with negative mean only, with upper and lower bounds reversed.


```{r assumptions_prop}
DT_prop <- data.table::data.table(
   data_space    = c("all_positive", "mixed_negative", "all_negative", "lower_negative", "central_lower_neg")
   , mean        = c(.558,           -0.1,             -0.1,            0.05,            -0.05)
   , lower       = c(.507,           -0.25,            -0.2,           -0.02,            -0.1)
   , upper       = c(.607,            1.3,             -0.05,           0.12,             0.1)
)
DT_prop|>
   journalR::format_journal_df(
      d_type = "prop"
      , remove_clu_columns = FALSE
   )
```


## Options 

The user's data.frame may be formatted differently than the simple case above, with different data types.

- Things get messy in the real world!

```{r options}
# build a mean/lower/upper summary table with some percentage from DT
DT_summary <- DT[
   , .(
        n            = .N
      , mean_mpg     = mean(mpg)
      , lower_mpg    = quantile(mpg, 0.025)
      , upper_mpg    = quantile(mpg, 0.975)
      , pct_vshape   = mean(vs) 
      , lower_vshape = quantile(vs, 0.025) 
      , upper_vshape = quantile(vs, 0.975) 
   )
   , by = cyl
]

```

As long as your table is tidy, it can be formatted.

```{r options_formatted}
DT_summary |>
   journalR::format_journal_df(
      d_type               = c("prop")
      , new_var            = "pct_vshape_fmt" # specify output colname (must be a new one)
      , central_var        = "pct_vshape" 
      , lower_var          = "lower_vshape"
      , upper_var          = "upper_vshape"
      , remove_clu_columns = FALSE # retain the original columns if desired
   )
```

## Styles

Two formatting styles are built into journalR, and the user may extend this.

- Nature (default)
- Lancet (particular)

```{r style_lancet, include=FALSE}
lancet <- data.table::as.data.table(stack(style_lancet()))
data.table::setcolorder(lancet, "ind")
data.table::setnames(lancet, c("ind", "values"), c("key", "value"))
```

Styles are a key/value list of metadata controlling rounding and formatting.

Here is an example of a very particular style, and how these values affect presentation tables. 

```{r style_lancet_show}
# print(style_lancet()) # as a list
print(lancet) # formatted a little nicer
```

Counts receive a non-standard thousands separator.

- Lancet decimals are `mid_dot()`.

```{r lancet_format_counts}
journalR::format_journal_df(
   data.frame(
        mean          = c(55.8e3, 54.7e6)
      , lower         = c(50.7e3, 48.6e6)
      , upper         = c(60.7e3, 59.6e6)
   )
   , d_type = "count"
   , style = "lancet"
)
```


Negatives are handled gracefully.

- Lancet negatives are `en_dash()`.

```{r lancet_format_prop}
journalR::format_journal_df(
   data.table::data.table(
                  data_space    = c("all_positive", "mixed_negative", "all_negative")
                , mean          = c(.5584654,       -0.15665,         -0.1321684)
                , lower         = c(.5076231,       -0.25321,         -0.235321)
                , upper         = c(.6076589,       1.365432,         -0.056549)
             )
   , d_type = "prop"
   , style = "lancet"
)
```

## Extending styles

Users may define their own styles by creating a named list with the same keys as the built-in styles.

- All arguments except the name have sensible defaults - only change what you need.
   - Read the `new_style()` documentation carefully to understand how each element affects your final output.
   - Using the "sigfig" `count_method` option involves the most assumptions
      - Read `fround_count()` source in 'R/format_vectors.R' for implementation details.

```{r new_style}

journalR::new_style(
   style_name            = 'wacky_style'
   , prop_digits_round   = 3
   , prop_nsmall         = 3
   , count_digits_sigfig = 5
   , count_method        = "sigfig"
   , count_pad_sigfigs   = TRUE
   , count_nsmall        = 3
   , neg_mark_mean       = "Negative "
   , neg_mark_UI         = en_dash()
   , UI_text             = "95%UI "
)
```


<!-- Perhaps the user prefers standard thousands separators for counts. -->

```{r apply_wacky_new_style}
# Counts
journalR::format_journal_df(
   data.frame(
        mean          = c(55.8e3, 54.7e6)
      , lower         = c(50.7e3, 48.6e6)
      , upper         = c(60.7e3, 59.6e6)
   )
   , d_type = "count"
   , style  = "wacky_style"
)

# Proportions
journalR::format_journal_df(
   data.table::data.table(
                  data_space    = c("all_positive", "mixed_negative", "all_negative")
                , mean          = c(.5584654, -0.15665, -0.1321684)
                , lower         = c(.5076231, -0.25321, -0.235321)
                , upper         = c(.6076589, 1.365432, -0.056549)
             )
   , d_type = "prop"
   , style = "wacky_style"
)
```


Done. 
